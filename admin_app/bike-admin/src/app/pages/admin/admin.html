<div class="layout">

  <aside class="sidebar">

    <div class="sidebar-header">
      <img src="/images/logo_header.png" class="logo" alt="logo">
      <h2 style="margin-top:20px;">Admin panel</h2>
    </div>

    <nav class="menu">
      <button class="menu-item" [class.active]="active==='bicikla'" (click)="setActive('bicikla')">
        <mat-icon>directions_bike</mat-icon>
        Bicikla
      </button>

      <button class="menu-item" [class.active]="active==='iznajmljivanja'" (click)="setActive('iznajmljivanja')">
        <mat-icon>calendar_month</mat-icon>
        Iznajmljivanja
      </button>

      <button class="menu-item" [class.active]="active==='problemi'" (click)="setActive('problemi')">
        <mat-icon>warning</mat-icon>
        Prijavljeni problemi
      </button>
    </nav>

    <div class="profile">
      <button class="menu-item" [class.active]="active==='profil'" (click)="setActive('profil')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="30" height="30">
          <circle cx="12" cy="8" r="4"/>
          <path d="M4 20c0-4 3.6-7 8-7s8 3 8 7" stroke-linecap="round"/>
        </svg>
        Moj profil
      </button>
    </div>
  </aside>

  <div class="main">
    <header class="header">
      <div></div>
      <div class="header-right">
        <span>{{ profile?.username }}</span>
        <span class="logout" (click)="logout()">
          <mat-icon>logout</mat-icon>
        </span>
      </div>
    </header>

    <div class="content">
      <div class="card" [class.no-card]="active === 'profil'">

        @switch (active) {

          <!-- ==================== BICIKLA ==================== -->
          @case ('bicikla') {

            <div class="bikes-header">
              <h2 class="bikes-title">Bicikla</h2>
              <button class="add-btn" (click)="openBikeModal()" aria-label="Dodaj bicikl">+</button>
            </div>
          
            <div class="search-bar">
              <mat-icon>search</mat-icon>
              <input
                type="text"
                placeholder="Pretraži bicikla..."
                [(ngModel)]="bikeSearch"
                (ngModelChange)="onBikeSearchChange()"
                class="search-input" />
            </div>
          
            <div class="bikes-body">
              <div class="table-wrap">
                <table class="bikes-table">
                  <thead>
                    <tr>
                      <th class="sortable" (click)="setBikeSort('id')">
                        ID {{ sortIcon('id', bikeSortCol, bikeSortDir) }}
                      </th>
                      <th class="sortable" (click)="setBikeSort('tip')">
                        Tip {{ sortIcon('tip', bikeSortCol, bikeSortDir) }}
                      </th>
                      <th class="sortable" (click)="setBikeSort('cena')">
                        Cena po h {{ sortIcon('cena', bikeSortCol, bikeSortDir) }}
                      </th>
                      <th class="sortable" (click)="setBikeSort('status')">
                        Status {{ sortIcon('status', bikeSortCol, bikeSortDir) }}
                      </th>
                      <th class="actions-th"></th>
                      <th class="actions-th"></th>
                    </tr>
                  </thead>
          
                  <tbody>
                    @for (b of filteredBikes; track b.id) {
                      <tr (click)="openBikeDetails(b)" class="clickable-row">
                        <td>#{{ b.id }}</td>
                        <td>{{ b.tip }}</td>
                        <td>{{ b.cena }} RSD</td>
          
                        <td>
                          @if (editingStatusId === b.id) {
                            <div class="status-edit-wrap">
                              <select class="status-select" [(ngModel)]="b.status">
                                @for (s of statusOptions; track s) {
                                  <option [value]="s">{{ s }}</option>
                                }
                              </select>
                              <button class="pill pill-confirm" (click)="$event.stopPropagation(); saveStatus(b)">✓</button>
                              <button class="pill pill-cancel" (click)="$event.stopPropagation(); cancelStatus()">✕</button>
                            </div>
                          } @else {
                            {{ b.status }}
                          }
                        </td>
          
                        <td class="action-td">
                          <button class="pill" (click)="$event.stopPropagation(); editStatus(b)">Izmeni status</button>
                        </td>
                        <td class="action-td">
                          <button class="pill" (click)="$event.stopPropagation(); openBikeModal(b)">Izmeni bicikl</button>
                        </td>
                      </tr>
                    }
          
                    @if (filteredBikes.length === 0) {
                      <tr>
                        <td colspan="6" class="no-results">Nema rezultata za "{{ bikeSearch }}"</td>
                      </tr>
                    }
                  </tbody>
                </table>
          
                @if (bikeTotalPages > 1) {
                  <div class="pagination">
                    <button class="page-btn" (click)="bikePage = bikePage - 1" [disabled]="bikePage === 1">‹</button>
                    @for (p of [].constructor(bikeTotalPages); track $index) {
                      <button class="page-btn"
                              [class.active]="bikePage === $index + 1"
                              (click)="bikePage = $index + 1">
                        {{ $index + 1 }}
                      </button>
                    }
                    <button class="page-btn" (click)="bikePage = bikePage + 1" [disabled]="bikePage === bikeTotalPages">›</button>
                  </div>
                }
          
              </div>
            </div>
          
            <!-- Bike modal (add/edit) -->
            @if (isBikeModalOpen) {
              <div class="modal-backdrop" (click)="closeBikeModal()">
                <div class="modal" (click)="$event.stopPropagation()">
          
                  <button class="modal-close" (click)="closeBikeModal()">×</button>
          
                  <h3 class="modal-title">
                    {{ bikeModalMode === 'add' ? 'Dodaj novi bicikl' : 'Izmeni bicikl' }}
                  </h3>
          
                  <div class="modal-form">
                    <div class="row">
                      <label>ID</label>
                      <input class="modal-input modal-text"
                             [value]="bikeModalMode === 'add' ? bikeForm.id : '#' + bikeForm.id"
                             readonly />
                    </div>
          
                    @if (bikeModalMode === 'add') {
                      <div class="qr-info">
                        <mat-icon>info</mat-icon>
                        QR kod se automatski generiše nakon dodavanja bicikla.
                      </div>
                    }
          
                    <div class="row">
                      <label>Tip</label>
                      <select class="modal-input modal-select"
                              [(ngModel)]="bikeForm.tip"
                              (ngModelChange)="onBikeTypeChange($event)">
                        <option value="" disabled>Izaberi tip</option>
                        @for (t of bikeTypes; track t.id) {
                          <option [value]="t.name">{{ t.name }}</option>
                        }
                      </select>
                    </div>
          
                    <div class="row">
                      <label>Cena po satu</label>
                      <input class="modal-input modal-text" type="number"
                             [(ngModel)]="bikeForm.cena" placeholder="12" />
                    </div>
          
                    <div class="row">
                      <label>Status</label>
                      <select class="modal-input modal-select" [(ngModel)]="bikeForm.status">
                        <option value="Dostupan">Dostupan</option>
                        <option value="Iznajmljen">Iznajmljen</option>
                        <option value="Neispravan">Neispravan</option>
                        <option value="Na održavanju">Na održavanju</option>
                      </select>
                    </div>
          
                    <div class="row">
                      <label>Latitude</label>
                      <input class="modal-input modal-text" type="number"
                             [(ngModel)]="bikeForm.latitude"
                             placeholder="npr. 44.8068" />
                    </div>
          
                    <div class="row">
                      <label>Longitude</label>
                      <input class="modal-input modal-text" type="number"
                             [(ngModel)]="bikeForm.longitude"
                             placeholder="npr. 20.4698" />
                    </div>
          
                    @if (bikeForm.tip === 'Električni') {
                      <div class="row">
                        <label>Baterija (%)</label>
                        <input class="modal-input modal-text" type="number"
                               [(ngModel)]="bikeForm.baterija"
                               placeholder="npr. 75"
                               min="0" max="100" />
                      </div>
                    }
                  </div>
          
                  @if (errorMessage) {
                    <div class="form-error">{{ errorMessage }}</div>
                  }
          
                  <button type="button"
                          class="modal-save"
                          (click)="saveBikeModal()"
                          [disabled]="bikeForm.cena <= 0 || isSaving">
                    {{ isSaving ? 'Čuvanje...' : 'Sačuvaj' }}
                  </button>
          
                </div>
              </div>
            }
          
            <!-- Bike details modal (istorija iznajmljivanja) -->
            @if (isBikeDetailOpen && selectedBikeDetail) {
              <div class="modal-backdrop" (click)="closeBikeDetails()">
                <div class="modal modal-wide" (click)="$event.stopPropagation()">
                  <button class="modal-close" (click)="closeBikeDetails()">×</button>
                  <h3 class="modal-title">Bicikl #{{ selectedBikeDetail.id }} — istorija iznajmljivanja</h3>
          
                  @if (bikeRentalsLoading) {
                    <p class="loading-text">Učitavanje...</p>
                  } @else if (bikeRentals.length === 0) {
                    <p class="no-results">Nema iznajmljivanja za ovaj bicikl.</p>
                  } @else {
                    <div class="bike-rentals-grid">
                      @for (r of bikeRentals; track r.id) {
                        <div class="bike-rental-card">
                          <img [src]="r.slika" alt="slika bicikla" class="bike-rental-img" />
                          <div class="bike-rental-info">
                            <p><strong>Korisnik:</strong> {{ r.korisnik }}</p>
                            <p><strong>Datum:</strong> {{ r.datum }}</p>
                            <p><strong>Vreme:</strong> {{ r.vreme }}</p>
                            <p><strong>Trajanje:</strong> {{ r.minuta }} min</p>
                            <p><strong>Cena:</strong> {{ r.cena }} RSD</p>
                          </div>
                        </div>
                      }
                    </div>
                  }
                </div>
              </div>
            }
          
          }

          <!-- ==================== IZNAJMLJIVANJA ==================== -->
          @case ('iznajmljivanja') {

            <div class="iznajmljivanja-header">
              <h2 class="iznajmljivanja-title">Iznajmljivanja</h2>
            </div>

            <div class="search-bar">
              <mat-icon>search</mat-icon>
              <input
                type="text"
                placeholder="Pretraži iznajmljivanja..."
                [(ngModel)]="rentalSearch"
                (ngModelChange)="onRentalSearchChange()"
                class="search-input" />
            </div>

            <div class="bikes-body">
              <div class="table-wrap">
                <table class="bikes-table">
                  <thead>
                    <tr>
                      <th class="sortable" (click)="setRentalSort('id')">
                        ID {{ sortIcon('id', rentalSortCol, rentalSortDir) }}
                      </th>
                      <th class="sortable" (click)="setRentalSort('korisnik')">
                        Korisnik {{ sortIcon('korisnik', rentalSortCol, rentalSortDir) }}
                      </th>
                      <th class="sortable" (click)="setRentalSort('datum')">
                        Datum {{ sortIcon('datum', rentalSortCol, rentalSortDir) }}
                      </th>
                      <th class="sortable" (click)="setRentalSort('vreme')">
                        Vreme {{ sortIcon('vreme', rentalSortCol, rentalSortDir) }}
                      </th>
                      <th class="sortable" (click)="setRentalSort('cena')">
                        Cena {{ sortIcon('cena', rentalSortCol, rentalSortDir) }}
                      </th>
                    </tr>
                  </thead>

                  <tbody>
                    @for (i of filteredRentals; track i.id) {
                      <tr (click)="openIznajmljivanje(i)" class="clickable-row">
                        <td>{{ i.id }}</td>
                        <td>{{ i.korisnik }}</td>
                        <td>{{ i.datum }}</td>
                        <td>{{ i.vreme }}</td>
                        <td>{{ i.cena }} RSD</td>
                      </tr>
                    }

                    @if (filteredRentals.length === 0) {
                      <tr>
                        <td colspan="5" class="no-results">Nema rezultata za "{{ rentalSearch }}"</td>
                      </tr>
                    }
                  </tbody>
                </table>

                <!-- Paginacija iznajmljivanja -->
                @if (rentalTotalPages > 1) {
                  <div class="pagination">
                    <button class="page-btn" (click)="rentalPage = rentalPage - 1" [disabled]="rentalPage === 1">‹</button>
                    @for (p of [].constructor(rentalTotalPages); track $index) {
                      <button class="page-btn"
                              [class.active]="rentalPage === $index + 1"
                              (click)="rentalPage = $index + 1">
                        {{ $index + 1 }}
                      </button>
                    }
                    <button class="page-btn" (click)="rentalPage = rentalPage + 1" [disabled]="rentalPage === rentalTotalPages">›</button>
                  </div>
                }

                @if (isIznajmljivanjeOpen && selectedIznajmljivanje) {
                  <div class="modal-backdrop" (click)="closeIznajmljivanje()">
                    <div class="modal" (click)="$event.stopPropagation()">
                      <button class="modal-close" (click)="closeIznajmljivanje()">×</button>
                      <h3 class="modal-title">Iznajmljivanje</h3>
                      <div class="details">
                        <p><strong>ID:</strong> {{ selectedIznajmljivanje.id }}</p>
                        <p><strong>Korisnik:</strong> {{ selectedIznajmljivanje.korisnik }}</p>
                        <p><strong>Datum i vreme:</strong> {{ selectedIznajmljivanje.datum }} {{ selectedIznajmljivanje.vreme }}</p>
                        <p><strong>Ukupno minuta:</strong> {{ selectedIznajmljivanje.minuta }}</p>
                        <p><strong>Tip bicikla:</strong> {{ selectedIznajmljivanje.tip }}</p>
                        <p><strong>Cena po minutu:</strong> {{ selectedIznajmljivanje.cenaPoMinutu }} RSD</p>
                        <p><strong>Cena ukupno:</strong> {{ selectedIznajmljivanje.cena }} RSD</p>
                        <p><strong>Fotografija:</strong></p>
                        <img [src]="selectedIznajmljivanje.slika" class="rental-photo" />
                      </div>
                    </div>
                  </div>
                }

              </div>
            </div>
          }

          <!-- ==================== PROBLEMI ==================== -->
          @case ('problemi') {

            <div class="problemi-header">
              <h2 class="problemi-title">Prijavljeni problemi</h2>
            </div>

            <div class="search-bar">
              <mat-icon>search</mat-icon>
              <input
                type="text"
                placeholder="Pretraži probleme..."
                [(ngModel)]="problemSearch"
                (ngModelChange)="onProblemSearchChange()"
                class="search-input" />
            </div>

            <div class="bikes-body">
              <div class="table-wrap">
                <table class="bikes-table">
                  <thead>
                    <tr>
                      <th class="sortable" (click)="setProblemSort('datum')">
                        Datum {{ sortIcon('datum', problemSortCol, problemSortDir) }}
                      </th>
                      <th class="sortable" (click)="setProblemSort('korisnik')">
                        Korisnik {{ sortIcon('korisnik', problemSortCol, problemSortDir) }}
                      </th>
                      <th class="sortable" (click)="setProblemSort('bikeId')">
                        Bicikl {{ sortIcon('bikeId', problemSortCol, problemSortDir) }}
                      </th>
                      <th>Opis problema</th>
                      <th>Fotografija</th>
                      <th class="sortable" (click)="setProblemSort('status')">
                        Status {{ sortIcon('status', problemSortCol, problemSortDir) }}
                      </th>
                      <th class="actions-th"></th>
                    </tr>
                  </thead>

                  <tbody>
                    @for (p of filteredProblems; track p.id) {
                      <tr>
                        <td>{{ p.datum }}</td>
                        <td>{{ p.korisnik }}</td>
                        <td>{{ p.bikeId }}</td>
                        <td>{{ p.opis }}</td>
                        <td class="photo-cell">
                          <img [src]="p.fotografija" alt="problem foto" class="problem-photo" />
                        </td>

                        <td>
                          @if (editingProblemId === p.id) {
                            <div class="status-edit-wrap">
                              <select class="status-select" [(ngModel)]="p.status">
                                @for (s of problemStatusOptions; track s) {
                                  <option [value]="s">{{ s }}</option>
                                }
                              </select>
                              <button class="pill pill-confirm" (click)="saveProblemStatus(p)">✓</button>
                              <button class="pill pill-cancel" (click)="cancelProblemStatus()">✕</button>
                            </div>
                          } @else {
                            {{ p.status }}
                          }
                        </td>

                        <td class="action-td">
                          <button class="pill" 
                                  (click)="editProblemStatus(p)"
                                  [disabled]="p.status !== 'Novo'">
                            Izmeni status
                          </button>
                        </td>
                      </tr>
                    }

                    @if (filteredProblems.length === 0) {
                      <tr>
                        <td colspan="7" class="no-results">Nema rezultata za "{{ problemSearch }}"</td>
                      </tr>
                    }
                  </tbody>
                </table>

                <!-- Paginacija problema -->
                @if (problemTotalPages > 1) {
                  <div class="pagination">
                    <button class="page-btn" (click)="problemPage = problemPage - 1" [disabled]="problemPage === 1">‹</button>
                    @for (p of [].constructor(problemTotalPages); track $index) {
                      <button class="page-btn"
                              [class.active]="problemPage === $index + 1"
                              (click)="problemPage = $index + 1">
                        {{ $index + 1 }}
                      </button>
                    }
                    <button class="page-btn" (click)="problemPage = problemPage + 1" [disabled]="problemPage === problemTotalPages">›</button>
                  </div>
                }

              </div>
            </div>
          }

          <!-- ==================== PROFIL ==================== -->
          @case ('profil') {

            <div class="profile-page">
              <h2 class="moj-profil-title">Moj profil</h2>

              <div class="avatar">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v3h20v-3c0-3.3-6.7-5-10-5z"/>
                </svg>
              </div>

              <div class="profile-grid">
                <div class="profile-form">

                  <div class="input-wrapper">
                    <span class="icon">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="8" r="4"/>
                        <path d="M4 20c0-4 3.6-7 8-7s8 3 8 7" stroke-linecap="round"/>
                      </svg>
                    </span>
                    <input class="input-field" [(ngModel)]="profile.username" [readonly]="true" />
                  </div>

                  <div class="input-wrapper" [class.editing]="isEditingProfile">
                    <span class="icon">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="8" r="4"/>
                        <path d="M4 20c0-4 3.6-7 8-7s8 3 8 7" stroke-linecap="round"/>
                      </svg>
                    </span>
                    <input class="input-field" [(ngModel)]="profile.ime" [readonly]="!isEditingProfile" />
                  </div>

                  <div class="input-wrapper" [class.editing]="isEditingProfile">
                    <span class="icon">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="8" r="4"/>
                        <path d="M4 20c0-4 3.6-7 8-7s8 3 8 7" stroke-linecap="round"/>
                      </svg>
                    </span>
                    <input class="input-field" [(ngModel)]="profile.prezime" [readonly]="!isEditingProfile" />
                  </div>

                  <div class="input-wrapper" [class.editing]="isEditingProfile">
                    <span class="icon">
                      <svg viewBox="0 0 24 24"><path d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1C10.07 21 3 13.93 3 5c0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.24.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
                    </span>
                    <input class="input-field" [(ngModel)]="profile.telefon" [readonly]="!isEditingProfile" />
                  </div>

                  <div class="input-wrapper" [class.editing]="isEditingProfile">
                    <span class="icon">
                      <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                    </span>
                    <input class="input-field" [(ngModel)]="profile.email" [readonly]="!isEditingProfile" />
                  </div>

                  <button class="profile-btn" (click)="toggleEditProfile()">
                    {{ isEditingProfile ? 'Sačuvaj' : 'Izmeni podatke' }}
                  </button>
                </div>

                <button class="change-pass" (click)="changePassword()">
                  <span class="lock-icon">
                    <svg viewBox="0 0 24 24"><path d="M12 17a2 2 0 002-2 2 2 0 10-4 0 2 2 0 002 2zm6-8h-1V7a5 5 0 00-10 0v2H6a2 2 0 00-2 2v9a2 2 0 002 2h12a2 2 0 002-2v-9a2 2 0 00-2-2zm-3 0H9V7a3 3 0 016 0v2z"/></svg>
                  </span>
                  Promeni lozinku
                </button>
              </div>
            </div>

            @if (isChangePassOpen) {
              <div class="modal-backdrop" (click)="closeChangePass()">
                <div class="modal-change-pass" (click)="$event.stopPropagation()">
                  <button class="modal-close" (click)="closeChangePass()">×</button>
                  <h3 class="modal-title">Promeni lozinku</h3>

                  <div class="modal-form">
                    <div class="pass-row">
                      <label>Stara lozinka:</label>
                      <input class="pass-input" type="password" [(ngModel)]="oldPassword" />
                    </div>
                    <div class="pass-row">
                      <label>Nova lozinka:</label>
                      <input class="pass-input" type="password" [(ngModel)]="newPassword" />
                    </div>
                    <div class="pass-row">
                      <label>Ponovi novu lozinku:</label>
                      <input class="pass-input" type="password" [(ngModel)]="confirmPassword" />
                    </div>
                  </div>

                  @if (passError) {
                    <p class="pass-error">{{ passError }}</p>
                  }

                  <button class="modal-save pass-save-btn" (click)="savePassword()">Sačuvaj</button>
                </div>
              </div>
            }

          }

        }

      </div>
    </div>
  </div>
  @if (successMessage) {
    <div class="toast">{{ successMessage }}</div>
  }
</div>